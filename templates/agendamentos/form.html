{% extends 'base.html' %}

{% block title %}{{ titulo }} - Sistema de Agendamento{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0"><i class="bi bi-calendar-plus"></i> {{ titulo }}</h4>
        </div>
        <div class="card-body">
            <form method="post" id="agendamentoForm">
                {% csrf_token %}
                
                <h5 class="mb-3">Informações do Agendamento</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.curso.id_for_label }}" class="form-label">{{ form.curso.label }}</label>
                        {{ form.curso }}
                        {% if form.curso.errors %}
                        <div class="text-danger small">{{ form.curso.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.veiculo.id_for_label }}" class="form-label">{{ form.veiculo.label }}</label>
                        {{ form.veiculo }}
                        {% if form.veiculo.errors %}
                        <div class="text-danger small">{{ form.veiculo.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.data_inicio.id_for_label }}" class="form-label">{{ form.data_inicio.label }}</label>
                        {{ form.data_inicio }}
                        {% if form.data_inicio.errors %}
                        <div class="text-danger small">{{ form.data_inicio.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.data_fim.id_for_label }}" class="form-label">{{ form.data_fim.label }}</label>
                        {{ form.data_fim }}
                        {% if form.data_fim.errors %}
                        <div class="text-danger small">{{ form.data_fim.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.observacoes.id_for_label }}" class="form-label">{{ form.observacoes.label }}</label>
                    {{ form.observacoes }}
                    {% if form.observacoes.errors %}
                    <div class="text-danger small">{{ form.observacoes.errors }}</div>
                    {% endif %}
                </div>

                <hr class="my-4">

                <h5 class="mb-3">Trajetos</h5>
                
                {{ formset.management_form }}
                
                <div id="trajetos-container">
                    {% for form in formset %}
                    <div class="trajeto-form card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Trajeto {{ forloop.counter }}</h6>
                                {% if is_edit or not forloop.first %}
                                <button type="button" class="btn btn-sm btn-outline-danger remove-trajeto">
                                    <i class="bi bi-trash"></i> Remover
                                </button>
                                {% endif %}
                            </div>
                            
                            {{ form.id }}
                            <div style="display: none;">
                                {{ form.DELETE }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Origem</label>
                                    {{ form.origem }}
                                    {% if form.origem.errors %}
                                    <div class="text-danger small">{{ form.origem.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Destino</label>
                                    {{ form.destino }}
                                    {% if form.destino.errors %}
                                    <div class="text-danger small">{{ form.destino.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data/Hora Saída</label>
                                    {{ form.data_saida }}
                                    {% if form.data_saida.errors %}
                                    <div class="text-danger small">{{ form.data_saida.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data/Hora Chegada</label>
                                    {{ form.data_chegada }}
                                    {% if form.data_chegada.errors %}
                                    <div class="text-danger small">{{ form.data_chegada.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Quilometragem (km)</label>
                                    {{ form.quilometragem }}
                                    {% if form.quilometragem.errors %}
                                    <div class="text-danger small">{{ form.quilometragem.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Descrição/Objetivo</label>
                                {{ form.descricao }}
                                {% if form.descricao.errors %}
                                <div class="text-danger small">{{ form.descricao.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <button type="button" class="btn btn-outline-secondary mb-4" id="add-trajeto">
                    <i class="bi bi-plus-circle"></i> Adicionar Trajeto
                </button>

                <hr>

                <div class="d-flex justify-content-between">
                    {% if is_edit %}
                    <a href="{% url 'agendamentos:detalhe' agendamento.pk %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                    {% else %}
                    <a href="{% url 'agendamentos:lista' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Salvar Agendamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/pt-BR.js"></script>
<script>
$(document).ready(function() {
    // Inicializar Select2 para Curso
    $('.select2-curso').select2({
        theme: 'bootstrap-5',
        language: 'pt-BR',
        placeholder: 'Selecione ou digite o nome do curso',
        allowClear: true,
        width: '100%'
    });
    
    // Inicializar Select2 para Veículo
    $('.select2-veiculo').select2({
        theme: 'bootstrap-5',
        language: 'pt-BR',
        placeholder: 'Selecione ou digite a placa/modelo do veículo',
        allowClear: true,
        width: '100%',
        // Personalizar como o texto é exibido na busca
        templateResult: formatVeiculo,
        templateSelection: formatVeiculoSelection
    });
    
    // Função para formatar a exibição do veículo na lista de resultados
    function formatVeiculo(veiculo) {
        if (!veiculo.id) {
            return veiculo.text;
        }
        // O texto já vem formatado do Django como "PLACA - MARCA MODELO"
        return veiculo.text;
    }
    
    // Função para formatar a exibição do veículo quando selecionado
    function formatVeiculoSelection(veiculo) {
        return veiculo.text || veiculo.id;
    }

    // Gerenciamento de formset inline
    let trajetoIndex = {{ formset.total_form_count }};
    
    // Função para validar datas dos trajetos
    function validarDatasTrajeto(trajetoForm) {
        const dataInicio = $('#id_data_inicio').val();
        const dataFim = $('#id_data_fim').val();
        const dataSaida = trajetoForm.find('input[name$="-data_saida"]').val();
        const dataChegada = trajetoForm.find('input[name$="-data_chegada"]').val();
        
        let erros = [];
        
        // Converter strings para objetos Date para comparação correta
        const dataInicioObj = dataInicio ? new Date(dataInicio) : null;
        const dataFimObj = dataFim ? new Date(dataFim) : null;
        const dataSaidaObj = dataSaida ? new Date(dataSaida) : null;
        const dataChegadaObj = dataChegada ? new Date(dataChegada) : null;
        
        // Formatar datas para exibição
        function formatarData(dateObj) {
            if (!dateObj) return '';
            const dia = String(dateObj.getDate()).padStart(2, '0');
            const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
            const ano = dateObj.getFullYear();
            const hora = String(dateObj.getHours()).padStart(2, '0');
            const min = String(dateObj.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${ano} ${hora}:${min}`;
        }
        
        // Validação 1: Data de chegada deve ser posterior à data de saída
        if (dataSaidaObj && dataChegadaObj && dataChegadaObj <= dataSaidaObj) {
            erros.push('A data de chegada deve ser posterior à data de saída.');
        }
        
        // Validação 2: Data de saída deve estar dentro do período do agendamento
        if (dataInicioObj && dataSaidaObj) {
            if (dataSaidaObj < dataInicioObj) {
                erros.push(`A data de saída não pode ser anterior ao início do agendamento (${formatarData(dataInicioObj)}).`);
            }
        }
        
        if (dataFimObj && dataSaidaObj) {
            if (dataSaidaObj > dataFimObj) {
                erros.push(`A data de saída não pode ser posterior ao fim do agendamento (${formatarData(dataFimObj)}).`);
            }
        }
        
        // Validação 3: Data de chegada deve estar dentro do período do agendamento
        if (dataInicioObj && dataChegadaObj) {
            if (dataChegadaObj < dataInicioObj) {
                erros.push(`A data de chegada não pode ser anterior ao início do agendamento (${formatarData(dataInicioObj)}).`);
            }
        }
        
        if (dataFimObj && dataChegadaObj) {
            if (dataChegadaObj > dataFimObj) {
                erros.push(`A data de chegada não pode ser posterior ao fim do agendamento (${formatarData(dataFimObj)}).`);
            }
        }
        
        return erros;
    }
    
    // Validar em tempo real quando as datas mudarem
    $(document).on('change', 'input[name$="-data_saida"], input[name$="-data_chegada"], #id_data_inicio, #id_data_fim', function() {
        $('.trajeto-form').each(function() {
            const trajetoForm = $(this);
            const erros = validarDatasTrajeto(trajetoForm);
            
            // Remove avisos anteriores
            trajetoForm.find('.alert-warning-dates').remove();
            
            // Adiciona novos avisos se houver erros
            if (erros.length > 0) {
                let alertHtml = '<div class="alert alert-warning alert-warning-dates mt-2 mb-0">';
                alertHtml += '<i class="bi bi-exclamation-triangle-fill"></i> <strong>Atenção:</strong><ul class="mb-0 mt-1">';
                erros.forEach(erro => {
                    alertHtml += '<li>' + erro + '</li>';
                });
                alertHtml += '</ul></div>';
                trajetoForm.find('.card-body').append(alertHtml);
            }
        });
    });
    
    // Validar ao submeter o formulário
    $('#agendamentoForm').on('submit', function(e) {
        let temErros = false;
        
        // Primeiro, remove todos os alertas antigos
        $('.alert-warning-dates').remove();
        
        $('.trajeto-form:visible').each(function() {
            const trajetoForm = $(this);
            
            // Pular se o trajeto está marcado para deletar
            const isDeleted = trajetoForm.find('input[name$="-DELETE"]').is(':checked');
            if (isDeleted) {
                return true; // continua para próximo trajeto
            }
            
            // Verificar se o trajeto tem pelo menos um campo preenchido
            const origem = trajetoForm.find('input[name$="-origem"]').val();
            const destino = trajetoForm.find('input[name$="-destino"]').val();
            const dataSaida = trajetoForm.find('input[name$="-data_saida"]').val();
            const dataChegada = trajetoForm.find('input[name$="-data_chegada"]').val();
            const quilometragem = trajetoForm.find('input[name$="-quilometragem"]').val();
            
            // Se o trajeto está completamente vazio, pular validação
            if (!origem && !destino && !dataSaida && !dataChegada && !quilometragem) {
                return true; // continua para próximo trajeto
            }
            
            // Se há dados preenchidos, validar
            const erros = validarDatasTrajeto(trajetoForm);
            
            if (erros.length > 0) {
                temErros = true;
                
                // Criar e mostrar o alerta visual
                let alertHtml = '<div class="alert alert-warning alert-warning-dates mt-2 mb-0">';
                alertHtml += '<i class="bi bi-exclamation-triangle-fill"></i> <strong>Atenção:</strong><ul class="mb-0 mt-1">';
                erros.forEach(erro => {
                    alertHtml += '<li>' + erro + '</li>';
                });
                alertHtml += '</ul></div>';
                trajetoForm.find('.card-body').append(alertHtml);
            }
        });
        
        if (temErros) {
            e.preventDefault();
            alert('Por favor, corrija os erros nos trajetos antes de salvar.');
            
            // Scroll para o primeiro alerta, se existir
            const firstAlert = $('.alert-warning-dates:first');
            if (firstAlert.length > 0) {
                $('html, body').animate({
                    scrollTop: firstAlert.offset().top - 100
                }, 500);
            }
        }
    });
    
    $('#add-trajeto').click(function() {
        let newForm = $('.trajeto-form:first').clone();
        newForm.find('input, textarea, select').each(function() {
            let name = $(this).attr('name');
            if (name) {
                name = name.replace('-0-', '-' + trajetoIndex + '-');
                $(this).attr('name', name);
                $(this).attr('id', 'id_' + name);
                $(this).val('');
            }
        });
        newForm.find('h6').text('Trajeto ' + (trajetoIndex + 1));
        
        // Garantir que o botão de remover existe e está visível
        let removeBtn = newForm.find('.remove-trajeto');
        if (removeBtn.length === 0) {
            // Se o botão não existe, criar um
            newForm.find('.d-flex.justify-content-between').append(
                '<button type="button" class="btn btn-sm btn-outline-danger remove-trajeto">' +
                '<i class="bi bi-trash"></i> Remover' +
                '</button>'
            );
        } else {
            // Se existe, garantir que está visível
            removeBtn.show();
        }
        
        newForm.find('.alert-warning-dates').remove(); // Remove alertas do form clonado
        $('#trajetos-container').append(newForm);
        $('#id_trajetos-TOTAL_FORMS').val(trajetoIndex + 1);
        trajetoIndex++;
    });
    
    $(document).on('click', '.remove-trajeto', function() {
        let form = $(this).closest('.trajeto-form');
        form.find('input[name$="-DELETE"]').prop('checked', true);
        form.hide();
    });
});
</script>
{% endblock %}
